<html>
	<body>
		<main>
			<select name="" id="league" onchange="refreshClubs()">
				<option value="L1" selected>Bundesliga</option>
				<option value="L2">2. Bundesliga</option>
				<option value="GB1">Premier League</option>
				<option value="ES1">LaLiga</option>
				<option value="IT1">Serie A</option>
				<option value="FR1">Ligue 1</option>

			</select>
			<select name="" id="club">
				<option value="" selected disabled>Club</option>
			</select><br><br>
			Saison
			<select name="" id="start-season" onchange="correctDate()">
			</select>
			bis
			<select name="" id="end-season" onchange="correctDate()">
			</select>
			<button onclick="refreshPlayers()">Go</button><br><br>
			Allow small errors: <input type="checkbox" id="errors-checkbox"><br><br>
			<input id="answer" type="text"><button id="submitBtn" onclick="checkAnswer()">Ok</button><br><br>
			<div id="players">
			</div>
		</main>
	</body>
	<script>
		//TODO: track and display correct answers
		//TODO: styling

		//buli: L1, serie a: IT1, laliga: ES1, prem: GB1, ligue 1: FR1
		//TODO: select club and season(s)

		const input = document.getElementById("answer");

		input.addEventListener("keypress", function(event) {
		if (event.key === "Enter") {
			event.preventDefault();
			document.getElementById("submitBtn").click();
		}
		});

		function fillSeasons(elementId) {
			const element = document.getElementById(elementId)
			let currentYear = new Date().getFullYear()
			const currentMonth = new Date().getMonth()
			if(currentMonth < 7) currentYear -= 1
			for(let i=0;i<10;i++) {
				const newOption = document.createElement("option")
				newOption.value = currentYear - i
				const twoDigitYear = currentYear - i - 2000
				newOption.innerText = twoDigitYear + "/" + (twoDigitYear+1)
				element.append(newOption)
			}
		}

		fillSeasons("start-season")
		fillSeasons("end-season")

		function refreshClubs() {
			const leagueID = document.getElementById("league").value
			fetch(`http://localhost/competitions/${leagueID}/clubs`).then(async (res) => {
				const data = await res.json()
				const clubsElement = document.getElementById("club")
				clubsElement.innerHTML = ""
				data.clubs.map((club) => {
					const newOption = document.createElement("option")
					newOption.value = club.id
					newOption.innerText = club.name
					clubsElement.append(newOption)
				})
			})
		}

		function correctDate() {
			const startSelect = document.getElementById("start-season")
			const endSelect = document.getElementById("end-season")

			if(parseInt(endSelect.value) < parseInt(startSelect.value)) {
				startSelect.value = endSelect.value
			}
		}

		//TODO: loading animation
		//TODO: error handling
		let indexAnswered = []
		let playerNames = []
		refreshClubs()

		function refreshPlayers() {
			playerNames = []
			const playersElement = document.getElementById("players")
			playersElement.innerHTML = ""
			
			const clubElement = document.getElementById("club")
			const startElement = document.getElementById("start-season")
			const endElement = document.getElementById("end-season")
			const reqs = []

			for (let i=parseInt(startElement.value);i<parseInt(endElement.value)+1;i++) {
				reqs.push(fetch(`http://localhost/clubs/${clubElement.value}/players?season_id=${i}`).then(res => res.json()))
			}

			Promise.all(reqs).then(dataArr => {
				dataArr.toReversed().map(res => res.players).flat().map((player, index) => {
					if(playerNames.includes(player.name)) return
					
					playerNames.push(player.name)
					const newElement = document.createElement('span')
					newElement.innerText = (playerNames.length) + ":"
					playersElement.append(newElement) //TODO: unsafe -> XSS
					playersElement.append(document.createElement('br'))
				})
			})

			indexAnswered = Array(playerNames.length).fill(false) //TODO: can this be handled better? one object for answer and isAnswered?
		}

		function normalizeName(name) {
			return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
		}

		function checkAnswer(){
			const answerInput = document.getElementById("answer")
			const answer = answerInput.value.toLowerCase()
			answerInput.value = ""

			const answerIndex = playerNames.findIndex((name, index) => !indexAnswered[index] && checkName(normalizeName(answer), normalizeName(name)))
			if(answerIndex === -1) return
			indexAnswered[answerIndex] = true
			document.getElementById("players").children[answerIndex*2].innerText+=" "+playerNames[answerIndex]
		}

		function checkMissingChar(errors, originalString, callback) {
			if (errors === 0) return errors
			for(let i=0;i<originalString.length;i++){
				const newString = originalString.substring(0, i) + originalString.substring(i + 1)
				const newErrors = callback(newString)
				if(newErrors < errors) errors = newErrors
			}
			return errors
		}

		function getErrorAmount(answerPart, correctPart) {
			//console.log(`answerPart: ${answerPart}, correctPart: ${correctPart}`)
			let errors = checkErrors(answerPart, correctPart)

			const errorCheckbox = document.getElementById("errors-checkbox")
			if (!errorCheckbox.checked || answerPart.length < 10) return errors //TODO: is this too harsh?

			//check if one char too much
			errors = checkMissingChar(errors, answerPart, (newAnswer) => checkErrors(newAnswer, correctPart))
			//check if one char missing
			errors = checkMissingChar(errors, correctPart, (newCorrect) => checkErrors(answerPart, newCorrect))

			return errors
		}

		function checkErrors(answerString, correctString) {
			let errors = Math.abs(answerString.length - correctString.length)
			const maxLength = Math.min(answerString.length, correctString.length)
			for(let i=0;i<maxLength;i++){
				if(answerString[i] !== correctString[i]) errors++
			}
			return errors
		}

		function checkName(name, correctName) {
			//TODO: why 6 errors allowed?
			if(!name || name.length === 0) return false

			const nameParts = correctName.toLowerCase().replace("-", " ").split(" ") //TODO: maybe split before replacing
			name = name.replaceAll(/ +/g, " ").replace("-", " ").trim()
			const answerParts = name.split(" ")

			let errors = 0
			answerParts.toReversed().map((answerPart, index) => errors += getErrorAmount(answerPart, nameParts.toReversed()[index]))

			const errorCheckbox = document.getElementById("errors-checkbox")
			const allowedErrors = errorCheckbox.checked ? Math.floor(correctName.length / 10) : 0
			if (errors <= allowedErrors) return true
			return false
		}
	</script>
</html>